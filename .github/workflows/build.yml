# =====================================================
# Certi-Hub CI/CD â€” Docker Buildx Bake
#
# PR ì‹œ: ë¹Œë“œ í…ŒìŠ¤íŠ¸ë§Œ (push âŒ)
# main í‘¸ì‹œ ì‹œ: ë¹Œë“œ + GHCR í‘¸ì‹œ + íƒœê·¸ ìžë™ ìƒì„±
# =====================================================

name: ðŸ—ï¸ Build & Push (Bake)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ (ê°™ì€ ë¸Œëžœì¹˜ì—ì„œ ì¤‘ë³µ ë¹Œë“œ ì·¨ì†Œ)
concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write   # GHCR í‘¸ì‹œ ê¶Œí•œ

jobs:
  bake:
    name: ðŸž Buildx Bake
    runs-on: ubuntu-latest

    steps:
      # ===== 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ =====
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      # ===== 2. QEMU (ë©€í‹° í”Œëž«í¼ ë¹Œë“œìš©) =====
      - name: ðŸ–¥ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      # ===== 3. Buildx ì„¤ì • =====
      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ===== 4. GitHub Container Registry ë¡œê·¸ì¸ =====
      - name: ðŸ” Login to GHCR
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ===== 5. ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì´ë¦„ ì†Œë¬¸ìž ë³€í™˜ + ì´ë¯¸ì§€ íƒœê·¸ ìƒì„± =====
      - name: ðŸ·ï¸ Generate tags
        id: meta
        run: |
          # Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì´ë¦„ì€ ë°˜ë“œì‹œ ì†Œë¬¸ìžì—¬ì•¼ í•¨
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "registry=ghcr.io/${OWNER_LC}" >> $GITHUB_OUTPUT
          # ì§§ì€ ì»¤ë°‹ í•´ì‹œ
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          # ë‚ ì§œ ê¸°ë°˜ íƒœê·¸
          DATE_TAG=$(date +'%Y%m%d')
          echo "tag=${DATE_TAG}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      # ===== 6. Bake â€” PR ì‹œ ë¹Œë“œë§Œ (push ì•ˆ í•¨) =====
      - name: ðŸ§ª Bake (PR í…ŒìŠ¤íŠ¸ ë¹Œë“œ)
        if: github.event_name == 'pull_request'
        uses: docker/bake-action@v5
        with:
          targets: prod
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
            *.platform=linux/amd64
        env:
          TAG: pr-${{ github.event.pull_request.number }}
          REGISTRY: ${{ steps.meta.outputs.registry }}
          NEXT_PUBLIC_API_URL: http://localhost

      # ===== 7. Bake â€” main í‘¸ì‹œ ì‹œ ë¹Œë“œ + ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ =====
      - name: ðŸš€ Bake & Push (Production)
        if: github.event_name == 'push'
        uses: docker/bake-action@v5
        with:
          targets: prod
          push: true
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
        env:
          TAG: ${{ steps.meta.outputs.tag }}
          REGISTRY: ${{ steps.meta.outputs.registry }}
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL || 'http://localhost' }}

      # ===== 8. ë¹Œë“œ ê²°ê³¼ ìš”ì•½ =====
      - name: ðŸ“‹ Build Summary
        if: github.event_name == 'push'
        run: |
          echo "## ðŸž Bake ë¹Œë“œ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ë¯¸ì§€ | íƒœê·¸ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ steps.meta.outputs.registry }}/certihub-backend\` | \`${{ steps.meta.outputs.tag }}\`, \`latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ steps.meta.outputs.registry }}/certihub-frontend\` | \`${{ steps.meta.outputs.tag }}\`, \`latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Pull: \`docker pull ${{ steps.meta.outputs.registry }}/certihub-backend:${{ steps.meta.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
