# =====================================================
# Certi-Hub CI/CD â€” Docker Buildx Bake
#
# âœ… ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œ (path filter)
# âœ… backend / frontend ë³‘ë ¬ ë¹Œë“œ (ë³„ë„ Job)
# âœ… BuildKit ìºì‹œ ë§ˆìš´íŠ¸ + GHA ìºì‹œ í™œìš©
#
# PR ì‹œ: ë¹Œë“œ í…ŒìŠ¤íŠ¸ë§Œ (push âŒ)
# main í‘¸ì‹œ ì‹œ: ë¹Œë“œ + GHCR í‘¸ì‹œ + íƒœê·¸ ìžë™ ìƒì„±
# =====================================================

name: ðŸ—ï¸ Build & Push (Bake)

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-bake.hcl'
      - 'docker-compose.prod.yml'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-bake.hcl'
      - '.github/workflows/build.yml'

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ (ê°™ì€ ë¸Œëžœì¹˜ì—ì„œ ì¤‘ë³µ ë¹Œë“œ ì·¨ì†Œ)
concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write   # GHCR í‘¸ì‹œ ê¶Œí•œ

# ============================================================
# Job 1: ë³€ê²½ëœ íŒŒì¼ ê°ì§€
# ============================================================
jobs:
  changes:
    name: ðŸ” ë³€ê²½ ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      infra: ${{ steps.filter.outputs.infra }}
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”Ž Path Filter
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            infra:
              - 'docker-bake.hcl'
              - 'docker-compose.prod.yml'
              - '.github/workflows/build.yml'

  # ============================================================
  # Job 2: ê³µí†µ ë©”íƒ€ë°ì´í„° (íƒœê·¸ ìƒì„±)
  # ============================================================
  meta:
    name: ðŸ·ï¸ ë©”íƒ€ë°ì´í„°
    runs-on: ubuntu-latest
    outputs:
      registry: ${{ steps.tags.outputs.registry }}
      tag: ${{ steps.tags.outputs.tag }}
    steps:
      - name: ðŸ·ï¸ Generate tags
        id: tags
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "registry=ghcr.io/${OWNER_LC}" >> $GITHUB_OUTPUT
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +'%Y%m%d')
          echo "tag=${DATE_TAG}-${SHORT_SHA}" >> $GITHUB_OUTPUT

  # ============================================================
  # Job 3: Backend ë¹Œë“œ
  # ============================================================
  build-backend:
    name: ðŸ Backend
    needs: [changes, meta]
    # backend íŒŒì¼ ë³€ê²½ ë˜ëŠ” ì¸í”„ë¼ ì„¤ì • ë³€ê²½ ì‹œì—ë§Œ ë¹Œë“œ
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ–¥ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to GHCR
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # PR: ë¹Œë“œë§Œ (amd64 only, push ì•ˆ í•¨)
      - name: ðŸ§ª Build (PR í…ŒìŠ¤íŠ¸)
        if: github.event_name == 'pull_request'
        uses: docker/bake-action@v5
        with:
          targets: backend-prod
          set: |
            *.cache-from=type=gha,scope=backend
            *.cache-to=type=gha,scope=backend,mode=max
            *.platform=linux/amd64

      # Push: ë¹Œë“œ + GHCR í‘¸ì‹œ
      - name: ðŸš€ Build & Push
        if: github.event_name == 'push'
        uses: docker/bake-action@v5
        with:
          targets: backend-prod
          push: true
          set: |
            *.cache-from=type=gha,scope=backend
            *.cache-to=type=gha,scope=backend,mode=max
        env:
          TAG: ${{ needs.meta.outputs.tag }}
          REGISTRY: ${{ needs.meta.outputs.registry }}

  # ============================================================
  # Job 4: Frontend ë¹Œë“œ
  # ============================================================
  build-frontend:
    name: âš›ï¸ Frontend
    needs: [changes, meta]
    # frontend íŒŒì¼ ë³€ê²½ ë˜ëŠ” ì¸í”„ë¼ ì„¤ì • ë³€ê²½ ì‹œì—ë§Œ ë¹Œë“œ
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ–¥ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to GHCR
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # PR: ë¹Œë“œë§Œ (amd64 only, push ì•ˆ í•¨)
      - name: ðŸ§ª Build (PR í…ŒìŠ¤íŠ¸)
        if: github.event_name == 'pull_request'
        uses: docker/bake-action@v5
        with:
          targets: frontend-prod
          set: |
            *.cache-from=type=gha,scope=frontend
            *.cache-to=type=gha,scope=frontend,mode=max
            *.platform=linux/amd64
        env:
          NEXT_PUBLIC_API_URL: http://localhost

      # Push: ë¹Œë“œ + GHCR í‘¸ì‹œ
      - name: ðŸš€ Build & Push
        if: github.event_name == 'push'
        uses: docker/bake-action@v5
        with:
          targets: frontend-prod
          push: true
          set: |
            *.cache-from=type=gha,scope=frontend
            *.cache-to=type=gha,scope=frontend,mode=max
        env:
          TAG: ${{ needs.meta.outputs.tag }}
          REGISTRY: ${{ needs.meta.outputs.registry }}
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL || 'http://localhost' }}

  # ============================================================
  # Job 5: ë¹Œë“œ ê²°ê³¼ ìš”ì•½
  # ============================================================
  summary:
    name: ðŸ“‹ Summary
    needs: [meta, build-backend, build-frontend]
    if: always() && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‹ Build Summary
        run: |
          echo "## ðŸž Bake ë¹Œë“œ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ì„œë¹„ìŠ¤ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.build-backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.build-frontend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ë¯¸ì§€ | íƒœê·¸ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ needs.meta.outputs.registry }}/certihub-backend\` | \`${{ needs.meta.outputs.tag }}\`, \`latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ needs.meta.outputs.registry }}/certihub-frontend\` | \`${{ needs.meta.outputs.tag }}\`, \`latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Pull: \`docker pull ${{ needs.meta.outputs.registry }}/certihub-backend:${{ needs.meta.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
