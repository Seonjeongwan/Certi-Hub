# =====================================================
# Certi-Hub ìˆ˜ë™ í¬ë¡¤ë§ ì›Œí¬í”Œë¡œìš°
#
# âš ï¸ ìë™ ìŠ¤ì¼€ì¤„(cron)ì€ ë¹„í™œì„±í™”ë¨
#    â†’ ì„œë²„ ë°°í¬ í›„ì—ëŠ” Docker ë‚´ë¶€ APSchedulerê°€ ìë™ í¬ë¡¤ë§ ë‹´ë‹¹
#    â†’ GitHub Actions ëŸ¬ë„ˆì—ì„œëŠ” DB ì ‘ê·¼ì´ ë¶ˆê°€í•˜ë¯€ë¡œ schedule ì‚¬ìš© ë¶ˆê°€
#
# ìˆ˜ë™ ì‹¤í–‰ ë°©ë²•:
#   GitHub ì €ì¥ì†Œ â†’ Actions â†’ "ğŸ•·ï¸ ìˆ˜ë™ í¬ë¡¤ë§" â†’ Run workflow
#   (DBê°€ ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥í•œ ê²½ìš°ì—ë§Œ ì‘ë™)
# =====================================================

name: ğŸ•·ï¸ ìˆ˜ë™ í¬ë¡¤ë§

on:
  workflow_dispatch:
    inputs:
      source:
        description: "í¬ë¡¤ë§ ì†ŒìŠ¤ ì„ íƒ"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - qnet
          - kdata
          - cloud
      database_url:
        description: "DB ì—°ê²° URL (ë¹„ì›Œë‘ë©´ secrets.DATABASE_URL ì‚¬ìš©)"
        required: false
        type: string

env:
  PYTHON_VERSION: "3.12"

jobs:
  crawl:
    name: ğŸ•·ï¸ ì‹œí—˜ ì¼ì • í¬ë¡¤ë§
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: pip install -r backend/requirements.txt

      - name: ğŸ”— DB ì—°ê²° í™•ì¸
        env:
          DATABASE_URL_SYNC: ${{ inputs.database_url || secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL_SYNC" ]; then
            echo "âŒ DB URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "   â†’ Repository secretsì— DATABASE_URLì„ ì„¤ì •í•˜ê±°ë‚˜"
            echo "   â†’ workflow_dispatch ì‹¤í–‰ ì‹œ database_urlì„ ì…ë ¥í•˜ì„¸ìš”."
            exit 1
          fi
          echo "âœ… DB URL í™•ì¸ë¨"

      - name: ğŸ•·ï¸ í¬ë¡¤ëŸ¬ ì‹¤í–‰
        env:
          DATABASE_URL_SYNC: ${{ inputs.database_url || secrets.DATABASE_URL }}
        working-directory: backend
        run: |
          SOURCE="${{ github.event.inputs.source || 'all' }}"
          echo "ğŸš€ í¬ë¡¤ë§ ì†ŒìŠ¤: $SOURCE"

          if [ "$SOURCE" = "all" ]; then
            python -m crawlers.run_crawlers
          elif [ "$SOURCE" = "qnet" ]; then
            python -m crawlers.run_crawlers --qnet
          elif [ "$SOURCE" = "kdata" ]; then
            python -m crawlers.run_crawlers --kdata
          elif [ "$SOURCE" = "cloud" ]; then
            python -m crawlers.run_crawlers --cloud
          fi

      - name: ğŸ“Š í¬ë¡¤ë§ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "========================================="
          echo "  í¬ë¡¤ë§ ì™„ë£Œ: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')"
          echo "========================================="
