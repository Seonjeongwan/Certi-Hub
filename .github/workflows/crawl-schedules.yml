# =====================================================
# Certi-Hub ìë™ í¬ë¡¤ë§ ì›Œí¬í”Œë¡œìš°
# guide.md 4.3ì ˆ: ìë™ ì—…ë°ì´íŠ¸ íŒŒì´í”„ë¼ì¸ (Automation)
# ë§¤ì¼ ì˜¤ì „ 9ì‹œ(KST) + ë§¤ì£¼ ì›”ìš”ì¼ ì‹œí—˜ ì¼ì • í¬ë¡¤ë§
# =====================================================

name: ğŸ“… ìê²©ì¦ ì‹œí—˜ ì¼ì • ìë™ í¬ë¡¤ë§

on:
  schedule:
    # ë§¤ì¼ KST ì˜¤ì „ 9ì‹œ (UTC 00:00)
    - cron: "0 0 * * *"
    # ë§¤ì£¼ ì›”ìš”ì¼ KST ì˜¤ì „ 6ì‹œ (UTC ì¼ìš”ì¼ 21:00) - ì „ì²´ ê°±ì‹ 
    - cron: "0 21 * * 0"
  workflow_dispatch:
    inputs:
      source:
        description: "í¬ë¡¤ë§ ì†ŒìŠ¤ ì„ íƒ"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - qnet
          - kdata
          - cloud

env:
  PYTHON_VERSION: "3.12"

jobs:
  crawl:
    name: ğŸ•·ï¸ ì‹œí—˜ ì¼ì • í¬ë¡¤ë§
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: pip install -r backend/requirements.txt

      - name: ğŸ•·ï¸ í¬ë¡¤ëŸ¬ ì‹¤í–‰
        env:
          DATABASE_URL_SYNC: ${{ secrets.DATABASE_URL }}
        working-directory: backend
        run: |
          SOURCE="${{ github.event.inputs.source || 'all' }}"
          echo "ğŸš€ í¬ë¡¤ë§ ì†ŒìŠ¤: $SOURCE"

          if [ "$SOURCE" = "all" ]; then
            python -m crawlers.run_crawlers
          elif [ "$SOURCE" = "qnet" ]; then
            python -m crawlers.run_crawlers --qnet
          elif [ "$SOURCE" = "kdata" ]; then
            python -m crawlers.run_crawlers --kdata
          elif [ "$SOURCE" = "cloud" ]; then
            python -m crawlers.run_crawlers --cloud
          fi

      - name: ğŸ“Š í¬ë¡¤ë§ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "========================================="
          echo "  í¬ë¡¤ë§ ì™„ë£Œ: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')"
          echo "========================================="
