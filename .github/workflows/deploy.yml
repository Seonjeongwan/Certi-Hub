# =====================================================
# Certi-Hub CI/CD íŒŒì´í”„ë¼ì¸
# main ë¸Œëœì¹˜ push ì‹œ ë¹Œë“œ ë° ë°°í¬
# =====================================================

name: ğŸš€ CI/CD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ===== ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ =====
  backend-test:
    name: ğŸ Backend í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: certihub_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: pip install -r backend/requirements.txt

      - name: ğŸ—„ï¸ DB ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™”
        env:
          PGPASSWORD: postgres
        run: |
          psql -h localhost -U postgres -d certihub_test -f database/init.sql

      - name: âœ… ë°±ì—”ë“œ ì‹¤í–‰ í™•ì¸
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/certihub_test
          DATABASE_URL_SYNC: postgresql+psycopg2://postgres:postgres@localhost:5432/certihub_test
        run: |
          cd backend
          python -c "from main import app; print('âœ… FastAPI app loaded successfully')"

  # ===== í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ =====
  frontend-build:
    name: âš›ï¸ Frontend ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        working-directory: frontend

      - name: ğŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: npm run build
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000

  # ===== Docker ì´ë¯¸ì§€ ë¹Œë“œ =====
  docker-build:
    name: ğŸ³ Docker ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ³ Docker Compose ë¹Œë“œ ê²€ì¦
        run: docker compose build
