# =====================================================
# Certi-Hub ì½”ë“œ ê²€ì¦ íŒŒì´í”„ë¼ì¸
# main ë¸Œëœì¹˜ push/PR ì‹œ ë¹ ë¥¸ ì½”ë“œ ê²€ì¦ (í…ŒìŠ¤íŠ¸ + lint)
#
# âš ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ & GHCR í‘¸ì‹œëŠ” build.yml (Bake)ì—ì„œ ë‹´ë‹¹
# âš ï¸ ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ì½”ë“œ í’ˆì§ˆ ê²€ì¦ë§Œ ìˆ˜í–‰ (ë¹ ë¥¸ í”¼ë“œë°±)
# =====================================================

name: ğŸ§ª í…ŒìŠ¤íŠ¸

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'database/**'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'database/**'

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===== ë°±ì—”ë“œ ì½”ë“œ ê²€ì¦ =====
  backend-test:
    name: ğŸ Backend í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: certihub_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: pip install -r backend/requirements.txt

      - name: ğŸ—„ï¸ DB ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™”
        env:
          PGPASSWORD: postgres
        run: |
          psql -h localhost -U postgres -d certihub_test -f database/init.sql

      - name: âœ… ë°±ì—”ë“œ ì‹¤í–‰ í™•ì¸
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/certihub_test
          DATABASE_URL_SYNC: postgresql+psycopg2://postgres:postgres@localhost:5432/certihub_test
        run: |
          cd backend
          python -c "from main import app; print('âœ… FastAPI app loaded successfully')"

  # ===== í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ê²€ì¦ (lint + type-checkë§Œ, ë¹Œë“œëŠ” build.ymlì—ì„œ) =====
  frontend-check:
    name: âš›ï¸ Frontend ê²€ì¦
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        working-directory: frontend

      - name: ğŸ” TypeScript íƒ€ì… ì²´í¬
        run: npm run type-check
        working-directory: frontend

      - name: ğŸ§¹ ESLint ê²€ì‚¬
        run: npm run lint
        working-directory: frontend
